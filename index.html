<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Photos ‚Äî Nightscout</title>
  <style>
    :root {
      --bg: #1a1a2e;
      --card-bg: #16213e;
      --text: #e0e0e0;
      --text-muted: #8a8a9a;
      --accent: #0f3460;
      --green: #4ecca3;
      --orange: #f5a623;
      --border: #2a2a4a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      text-align: center;
      padding: 20px 0 30px;
    }

    .header h1 {
      font-size: 1.8em;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .header .subtitle {
      color: var(--text-muted);
      font-size: 0.95em;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .controls select, .controls input, .controls button {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-size: 0.9em;
    }

    .controls button {
      background: var(--green);
      color: #1a1a2e;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .controls button:hover { opacity: 0.85; }

    .timeline {
      max-width: 720px;
      margin: 0 auto;
    }

    .day-label {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--green);
      padding: 16px 0 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .meal-card {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      transition: transform 0.15s;
    }

    .meal-card:hover { transform: translateY(-2px); }

    .meal-card img {
      width: 100%;
      max-height: 400px;
      object-fit: cover;
      cursor: pointer;
      display: block;
    }

    .meal-card .info {
      padding: 16px;
    }

    .meal-card .time {
      font-size: 0.85em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .meal-card .description {
      font-size: 1em;
      line-height: 1.5;
    }

    .meal-card .carbs-badge {
      display: inline-block;
      margin-top: 8px;
      padding: 3px 10px;
      border-radius: 12px;
      background: var(--accent);
      color: var(--orange);
      font-size: 0.85em;
      font-weight: 600;
    }

    .no-photos {
      text-align: center;
      color: var(--text-muted);
      padding: 60px 20px;
      font-size: 1.1em;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: var(--text-muted);
    }

    .spinner {
      display: inline-block;
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Lightbox */
    .lightbox {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      cursor: zoom-out;
    }

    .lightbox.active { display: flex; }

    .lightbox img {
      max-width: 95vw;
      max-height: 95vh;
      border-radius: 8px;
    }

    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .stat {
      text-align: center;
    }

    .stat .value {
      font-size: 1.6em;
      font-weight: 700;
      color: var(--green);
    }

    .stat .label {
      font-size: 0.8em;
      color: var(--text-muted);
      margin-top: 2px;
    }

    @media (max-width: 600px) {
      body { padding: 12px; }
      .header h1 { font-size: 1.4em; }
      .meal-card img { max-height: 280px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üçΩÔ∏è Meal Photos</h1>
    <p class="subtitle">Food log with photos from Nightscout treatments</p>
  </div>

  <div class="controls">
    <input type="date" id="dateFrom" />
    <input type="date" id="dateTo" />
    <button onclick="loadMeals()">Refresh</button>
  </div>

  <div class="stats-bar" id="statsBar" style="display:none">
    <div class="stat">
      <div class="value" id="statMeals">0</div>
      <div class="label">Meals</div>
    </div>
    <div class="stat">
      <div class="value" id="statCarbs">0</div>
      <div class="label">Total Carbs (g)</div>
    </div>
    <div class="stat">
      <div class="value" id="statPhotos">0</div>
      <div class="label">Photos</div>
    </div>
  </div>

  <div class="timeline" id="timeline">
    <div class="loading">
      <div class="spinner"></div>
      <div>Loading meals‚Ä¶</div>
    </div>
  </div>

  <div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <img id="lightboxImg" src="" alt="Meal photo" />
  </div>

  <script>
    // --- Config ---
    // If running locally (dev), use local proxy; otherwise hit Nightscout directly
    const NS_URL = window.location.hostname === 'localhost'
      ? window.location.origin
      : 'https://p01--sefi--s66fclg7g2lm.code.run';
    const TZ_OFFSET = -8; // PST

    // --- Init ---
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);

    document.getElementById('dateFrom').value = fmt(weekAgo);
    document.getElementById('dateTo').value = fmt(today);

    function fmt(d) {
      return d.toISOString().split('T')[0];
    }

    function toPST(utcStr) {
      const d = new Date(utcStr);
      const pst = new Date(d.getTime() + TZ_OFFSET * 3600000);
      return pst;
    }

    function formatTime(utcStr) {
      const d = new Date(utcStr);
      return d.toLocaleString('en-US', {
        timeZone: 'America/Los_Angeles',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }

    function formatDate(utcStr) {
      const d = new Date(utcStr);
      return d.toLocaleDateString('en-US', {
        timeZone: 'America/Los_Angeles',
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });
    }

    function extractPhotoUrls(notes) {
      if (!notes) return [];
      const regex = /https?:\/\/(?:files\.catbox\.moe|iili\.io|cdn\.jsdelivr\.net|javordlab\.github\.io)\/\S+/g;
      return notes.match(regex) || [];
    }

    function extractDescription(notes) {
      if (!notes) return '';
      // Remove photo URLs and emoji
      return notes
        .replace(/üì∑\s*https?:\/\/\S+/g, '')
        .replace(/https?:\/\/(?:files\.catbox\.moe|iili\.io|cdn\.jsdelivr\.net|javordlab\.github\.io)\/\S+/g, '')
        .trim();
    }

    function openLightbox(src) {
      document.getElementById('lightboxImg').src = src;
      document.getElementById('lightbox').classList.add('active');
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('active');
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeLightbox();
    });

    async function loadMeals() {
      const from = document.getElementById('dateFrom').value;
      const to = document.getElementById('dateTo').value;

      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading meals‚Ä¶</div></div>';

      try {
        const fromDate = new Date(from + 'T00:00:00-08:00').toISOString();
        const toDate = new Date(to + 'T23:59:59-08:00').toISOString();

        const url = `${NS_URL}/api/v1/treatments.json?find[eventType]=Meal Bolus&find[created_at][$gte]=${fromDate}&find[created_at][$lte]=${toDate}&count=100`;

        const res = await fetch(url);
        const treatments = await res.json();

        // Filter to only treatments with photo URLs
        const withPhotos = treatments.filter(t => extractPhotoUrls(t.notes).length > 0);

        // Also keep meals without photos for stats
        const allMeals = treatments;

        if (allMeals.length === 0) {
          timeline.innerHTML = '<div class="no-photos">No meals found for this date range.</div>';
          document.getElementById('statsBar').style.display = 'none';
          return;
        }

        // Stats
        const totalCarbs = allMeals.reduce((sum, t) => sum + (t.carbs || 0), 0);
        document.getElementById('statMeals').textContent = allMeals.length;
        document.getElementById('statCarbs').textContent = totalCarbs;
        document.getElementById('statPhotos').textContent = withPhotos.length;
        document.getElementById('statsBar').style.display = 'flex';

        if (withPhotos.length === 0) {
          timeline.innerHTML = '<div class="no-photos">No meal photos found. Photos appear when treatments include Catbox image URLs in notes.</div>';
          return;
        }

        // Sort by date descending
        withPhotos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        // Group by day (PST)
        const grouped = {};
        for (const t of withPhotos) {
          const dayKey = formatDate(t.created_at);
          if (!grouped[dayKey]) grouped[dayKey] = [];
          grouped[dayKey].push(t);
        }

        let html = '';
        for (const [day, meals] of Object.entries(grouped)) {
          html += `<div class="day-label">${day}</div>`;
          for (const meal of meals) {
            const photos = extractPhotoUrls(meal.notes);
            const desc = extractDescription(meal.notes);
            const time = formatTime(meal.created_at);

            html += `<div class="meal-card">`;
            for (const photoUrl of photos) {
              html += `<img src="${photoUrl}" alt="Meal photo" onclick="openLightbox('${photoUrl}')" loading="lazy" />`;
            }
            html += `<div class="info">`;
            html += `<div class="time">üïê ${time}</div>`;
            html += `<div class="description">${desc}</div>`;
            if (meal.carbs) {
              html += `<span class="carbs-badge">${meal.carbs}g carbs</span>`;
            }
            html += `</div></div>`;
          }
        }

        timeline.innerHTML = html;

      } catch (err) {
        timeline.innerHTML = `<div class="no-photos">Error loading meals: ${err.message}</div>`;
        console.error(err);
      }
    }

    // Load on start
    loadMeals();
  </script>
</body>
</html>
